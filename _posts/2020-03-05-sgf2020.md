---
title: 'Bootstrap Resampling At Scale'
date: 2020-03-06 00:00:00
description: Automatically distributed bootstrap resampling
featured_image: '/images/blog/sgf2020/Slide 3.gif'
tags: clinical-trials workflow types-of-computing bootstrap resampling
---

# Using CAS In SAS Viya for Bootstrap Resampling And Faster Inference For Clinical Trial Results
Initially, this was going to be a demonstration presented at SAS Global Forum 2020.  I was looking forward to sharing this resampling action set project with this example demonstration.  The next best thing is learning a new way to present slides and annotate them in blog form.  Thank you for visiting and reviewing the following.  I welcome your feedback on the content as well as the presentation format!

## Outline
- [Introduction](#introduction)
- [Background & Setup](#background--setup)
- [Bootstrap Resampling in One Line](#bootstrap-in-one-line)
- [An Example Workflow](#an-example-workflow)
- [An Application with Bootstrap Resampling](#an-application-with-bootstrap-resampling)
- [More Details](#more-details)
- [Wrapup](#wrapup)

___
### Introduction
---

![](/images/blog/sgf2020/Slide 1.png)

My copresenter, [Jesse Behrens](https://github.com/jessebehrens), giving feedback and encouragement is why this demonstration exists.  My first inclination was to wait a year due to a shoulder surgery prohibiting my travel and participation.  Instead of delaying, Jesse helped me out and prepared to present in my place.  Thank You!

![](/images/blog/sgf2020/Slide 2.png)

The [bootstrap](https://en.wikipedia.org/wiki/Bootstrapping_(statistics)) is a technique that allows us to learn from limited data and assess the uncertainty of our findings.  The technique is attributed to [Bradley Efron](http://statweb.stanford.edu/~ckirby/brad/), and its importance was recently acknowledged by awarding him the [International Prize in Statistics](https://statprize.org/previouswinners.cfm) in 2019.  

___
### Background & Setup
---

<img data-gifffer="/images/blog/sgf2020/Slide 3.gif">

The process of bootstrap resampling is simple to describe.  A resample is constructed by randomly drawing a case from the original sample, replace it, then repeat this up to the size of the resample.  This process repeats to construct the desired number of bootstrap resamples.  

This process can be easily parallelized by simultaneously taking drawings and doing each bootstrap resample at the same time on different computer processors. 

SAS Viya's [CAS engine](https://documentation.sas.com/?docsetId=viyaov&docsetTarget=n00000sasviya000architecture.htm&docsetVersion=3.5&locale=en#n08ohiggqnx6hsn1cx1b1cm41011) is a perfect environment to achieve this type of parallelization.  Instructions can be written once and distributed to all available compute processors via threads.  Let's take a closer look at SAS Viya's architecture to understand how all of this works.

In the animation above (click to play), we see the key components of SAS Viya displayed.  
- The first part is a SAS 9.4 workspace.  This component gives users a working SAS 9 session when they log into a SAS interface, such as SAS Studio.
- The second part is called CAS, which is a distributed computing environment made up of multiple servers working together.
- The CAS controller conducts the orchestration of work within CAS. Instructions are received and distributed to threads assigned to each processor in the CAS environment.
- The actual computation happens on CAS workers where each machine's processors have an assignment to computing threads. An environment can contain any number of CAS workers.

For bootstrap resampling, we want to request B resamples and have them evenly distribute across T threads.  For example, an environment may have 100 threads, that each goes to work processing 10 bootstrap resamples when we request 1000 total bootstrap resamples.

Let's look at how to send instructions to CAS on the next slide.

![](/images/blog/sgf2020/Slide 4.gif)

To trigger execution in a CAS environment, we have several options.  The most common way for SAS programmers to request computation is by using SAS code comprised of procs (procedures).  There are many new, [CAS enable procs](https://documentation.sas.com/?cdcId=pgmsascdc&cdcVersion=9.4_3.5&docsetId=allprodsproc&docsetTarget=p1o1v16by0iotvn10m0jzzv9i3y8.htm&locale=en) that direct their computations to occur in a CAS environment.  

Underneath procs, there is a new layer of programming available to SAS programmers with Viya.  These building blocks are called [CAS actions](https://documentation.sas.com/?cdcId=pgmsascdc&cdcVersion=9.4_3.5&docsetId=allprodsactions&docsetTarget=actionsByName.htm&locale=en).  There are many groups of actions that come with SAS Viya products, and these are called [action sets](https://documentation.sas.com/?cdcId=pgmsascdc&cdcVersion=9.4_3.5&docsetId=allprodsactions&docsetTarget=actionSetsByName.htm&locale=en). 

SAS Programmers can use these actions in a new proc, [PROC CAS](https://documentation.sas.com/?cdcId=pgmsascdc&cdcVersion=9.4_3.5&docsetId=proccas&docsetTarget=n1gq4olyaoyw7kn1g4hvz6gyoxoj.htm&locale=en).   This proc allows users to directly program and interact with CAS actions in a language called [CASL](https://documentation.sas.com/?cdcId=pgmsascdc&cdcVersion=9.4_3.5&docsetId=casl&docsetTarget=titlepage.htm&locale=en).

For users that are comfortable with other languages, like [R]() and [Python](https://documentation.sas.com/?cdcId=pgmsascdc&cdcVersion=9.4_3.5&docsetId=caspg3&docsetTarget=titlepage.htm&locale=en), these same actions get triggered via an API.  This functionality bypasses the need for a SAS interface, which has a SAS 9.4 workspace, by directly sending instructions to the CAS controller.

In our examples, we use CAS actions for bootstrap resampling from a SAS interface (SAS Studio) and use PROC CAS.

<img data-gifffer="/images/blog/sgf2020/Slide 5.gif">

The bootstrap resampling action is part of a [user-defined action set](https://documentation.sas.com/?cdcId=pgmsascdc&cdcVersion=9.4_3.5&docsetId=caspg&docsetTarget=cas-builtins-defineactionset.htm&locale=en) called resample.  This action set does not come with SAS Viya but is easily added to an environment from its [public GitHub repository](https://github.com/statmike/Resampling-Methods-in-SAS-Viya).  

The animation on this slide shows the whole process: download the single file from GitHub and run it from a SAS interface in the SAS Viya environment.  

---
### Bootstrap in One Line
---

![](/images/blog/sgf2020/Slide 6.gif)

The process of requesting bootstrap sampling gets fully specified in a single line of code, as highlighted in this slides animation. 

<img data-gifffer="/images/blog/sgf2020/Slide 7.gif">

Using CAS from a SAS interface, like SAS Studio, has three components.  The animated slide above (click to play) illustrates this process.  Here is what is going on:

- Create a CAS session and make a libname to exchange data with it
    - [CAS statement](https://documentation.sas.com/?cdcId=pgmsascdc&cdcVersion=9.4_3.5&docsetId=casref&docsetTarget=n0z3r80fjqpobvn1lvegno9gefni.htm&locale=en) creates a CAS session
    - [libname CAS](https://documentation.sas.com/?cdcId=pgmsascdc&cdcVersion=9.4_3.5&docsetId=casref&docsetTarget=p0lti7m8oeo1bqn1nnq84mco40ut.htm&locale=en) creates a libname reference to the CAS session
- Load the sample data into CAS
    - Here, [PROC CASUTIL](https://documentation.sas.com/?cdcId=pgmsascdc&cdcVersion=9.4_3.5&docsetId=casref&docsetTarget=p1momv516ndlt7n1vhgva4urpuk6.htm&locale=en) is used to load the sashelp.heart data (described in detail on the next slide)
- Run the bootstrap action against the sample data to create the resample dataset
    - First, the resample action set is loaded for the session
    - Then, resample.bootstrap is used to request 1000 bootstrap resamples of the same size as the sample data

---
### An Example Workflow
---

![](/images/blog/sgf2020/Slide 8.png)

The dataset sashelp.heart is epidemiological study data from the [Framingham Heart Study (FHS)](https://www.nhlbi.nih.gov/science/framingham-heart-study-fhs), which began in 1948 and included 5,209 men and women.  This slide covers some key details of this data set.

<img data-gifffer="/images/blog/sgf2020/Slide 9.gif">

As a continuation of two slides back, let's build out an inferential workflow.  We have a CAS session, the sample data (sashelp.heart) is loaded (mycas.heart), and the bootstrap action has created mycas.heart_bs with 1000 bootstrap resamples.  

This slide (click to play) illustrates the steps of basic inferential workflow.

First, the full data is analyzed with one of the new CAS enable procs, PROC Logselect.  This proc is very similar to PROC Logistic but has additional features to take advantage of distributed computing in CAS.  

Next, the same work in PROC Logselect triggers using the regression. Logistic action in PROC CAS.  The selection method and the model are specified to consider all pairwise interactions, a unique feature of the action.  

Following the inference and model selection on the full data, the final selected model is rerun and saved using PROC CAS with the regression. Logistic action and using the output features.  

The same model is fitted with nearly identical PROC CAS code to the bootstrap resample in mycas.heart_BS but specifying a groupby variable to indicate the different bootstrap samples (bsID). The parameter estimates from each resample model fit save to an output dataset.  The computation distributes since individual computing threads allocate to processors with subsets of resamples.  

Wrapping up, another action, resample.percentilePE, is used to calculate the 95% percentile confidence intervals for each parameter across all the resample model fits.  PROC SGPLOT is then used to visuall compares the full data parameter estimates with the bootstrap parameter estimates.  

We review these results, in detail, on the next slide.

![](/images/blog/sgf2020/Slide 10.png)

A closer review of the results reveals the benefit of the bootstrap approach.  

First, on the left, we can see the parameter estimates with two types of confidence intervals: 95% intervals from the model fit and 95% percentile intervals from the fits to bootstrap resamples.  For all parameters, the intervals and parameter estimate tightly align, showing how robust the model fit the sample is.  In this case, the bootstrap works as a confirmation of our inference from the sample. 

Next, on the right, the residual from each bootstrap resample model fit contributes to the construction of 95% percentile intervals for the residuals.  This chart shows individual data points with 95% percentile intervals for residuals and filters to just the sample cases with the bootstrap estimate (50th percentile) > 0.94.  In this inference, we are explaining status = dead or alive.  In all matching cases, the inferred status is that the patient is alive while the residual >0.94 indicates they are dead.  These are all cases where the model fit drastically missed the patient's status and fail to understand why they died.  It could be that they died from other causes, and the explanatory variables fail to explain this.  In any event, these cases are worth a further review, and the bootstrap percentile intervals helped identify them.  

---
### An Application with Bootstrap Resampling
---

![](/images/blog/sgf2020/Slide 11.png)

![](/images/blog/sgf2020/Slide 12.gif)

![](/images/blog/sgf2020/Slide 13.gif)

![](/images/blog/sgf2020/Slide 14.png)

![](/images/blog/sgf2020/Slide 15.png)

![](/images/blog/sgf2020/Slide 16.png)

![](/images/blog/sgf2020/Slide 17.gif)

![](/images/blog/sgf2020/Slide 18.png)

---
### More Details
---

![](/images/blog/sgf2020/Slide 19.png)

In the example and application presented here, the focus has been on simple bootstrap resampling.  The resample action set contains many more capabilities, including more complex bootstrap scenarios.  

For bootstrap resampling, there are options to resample cases rather than rows and to resample within strata groups.  For stratified resampling, there are options to fix the size in each group, use the sample data group size, and even specify a random distribution and parameters to pick sample sizes for each stratum in each bootstrap resample.

Additional actions are available for jackknife resampling and double bootstrap, creating bootstrap resamples for each bootstrap resample.    

Many examples are provided for using the actions in different applications.  On such example is using these actions to [conduct residual bootstrapping](https://github.com/statmike/Resampling-Methods-in-SAS-Viya/blob/master/examples/example%207%20-%20residual%20bootstraping.sas).

I invite you to review the [detailed documentation on the resample action set GitHub repository](https://github.com/statmike/Resampling-Methods-in-SAS-Viya) and post questions and feature requests as issues in the repository.

<img data-gifffer="/images/blog/sgf2020/Slide 20.gif">


As always, SAS provides more than one way to achieve your data analysis objectives, and SAS Viya is no exception.  For users who are familiar with SAS/IML syntax and matrix programming, they find that [SAS IML on CAS](https://documentation.sas.com/?cdcId=pgmsascdc&cdcVersion=9.4_3.5&docsetId=allprodsactions&docsetTarget=SAS-IML.htm&locale=en) offers distributed computation with the same syntax they are familiar with is [SAS/IML on SAS 9](https://documentation.sas.com/?cdcId=pgmsascdc&cdcVersion=9.4_3.5&docsetId=imlug&docsetTarget=titlepage.htm&locale=en).  

The documentation for [SAS IML](https://documentation.sas.com/?cdcId=pgmsascdc&cdcVersion=9.4_3.5&docsetId=allprodsactions&docsetTarget=SAS-IML.htm&locale=en) includes an [example of residual bootstrapping](https://documentation.sas.com/?cdcId=pgmsascdc&cdcVersion=9.4_3.5&docsetId=casactiml&docsetTarget=casactiml_iml_examples36.htm&locale=en) in CAS.

---
### Wrapup
Thank you for visiting this demonstration in the blog form.  I hope that it has been of value to you.  I welcome your feedback and engagement!

---

<script type="text/javascript" src="/js/gifffer.min.js"></script>

<script>window.onload=function(){Gifffer();}</script>
